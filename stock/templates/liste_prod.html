{% extends "base/base.html" %}

{% load static %}
{% block title %}Bienvenue sur {% endblock %}

{% block css %}
{% endblock css %}

{% block toolbar %}
<div id="kt_app_toolbar" class="app-toolbar" style="height: 50px">
    <div id="kt_app_toolbar_container" class="app-container container-fluid d-flex flex-stack">
        <div class="page-title d-flex flex-column justify-content-center flex-wrap me-3">
            <ul class="nav nav-custom nav-tabs nav-line-tabs nav-line-tabs-2x border-0 fs-4 fw-semibold mb-8 mt-8">
                <li class="nav-item text-end">
                    <a class="nav-link text-active-primary active" data-bs-toggle="tab"
                       href="#kt_customer_view_overview_tab">Liste des Produits</a>
                </li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block content %}
<form method="get" action="">
    <div class="form-group">
        <label for="filter_type">Filtrer par:</label>
        <select id="filter_type" name="filter_type" class="form-control">
            <option value="">Sélectionner un filtre</option>
            <option value="category" {% if selected_filter_type == 'category' %}selected{% endif %}>Catégorie</option>
            <option value="site" {% if selected_filter_type == 'site' %}selected{% endif %}>Site</option>
            <option value="utilisateur" {% if selected_filter_type == 'utilisateur' %}selected{% endif %}>Utilisateur</option>
        </select>
    </div>
    <div class="form-group" id="filter_value_container" {% if not selected_filter_type %}style="display: none;"{% endif %}>
        <label for="filter_value">Valeur:</label>
        <select id="filter_value" name="filter_value" class="form-control">
            <option value="">Tous</option>
        </select>
    </div>
    <button type="submit" class="btn btn-primary">Filtrer</button>
    <a href="{% url 'liste_produits_pdf' %}?filter_type={{ selected_filter_type }}&filter_value={{ selected_filter_value }}" class="btn btn-secondary">Exporter en PDF</a>
</form>

<table class="table mt-4">
    <thead>
        <tr>
            <th>Code Interne</th>
            <th>Marque</th>
            <th>Date d'Inventaire</th>
            <th>Catégorie</th>
            <th>Site</th>
            <th>Utilisateur</th>
        </tr>
    </thead>
    <tbody>
        {% for produit in produits %}
            <tr>
                <td>{{ produit.code_interne }}</td>
                <td>{{ produit.marque }}</td>
                <td>{{ produit.date_inventaire|date:"d/m/Y" }}</td>
                <td>{{ produit.categorie.nom_cat }}</td>
                <td>{{ produit.site.nom }}</td>
                <td>{{ produit.utilisateur.nom_util }}</td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="6">Aucun produit trouvé.</td>
            </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock content %}

{% block javascript %}
<script>
    document.getElementById('filter_type').addEventListener('change', function() {
        var filterType = this.value;
        var filterValueContainer = document.getElementById('filter_value_container');
        var filterValueSelect = document.getElementById('filter_value');

        filterValueContainer.style.display = filterType ? 'block' : 'none';

        filterValueSelect.innerHTML = '<option value="">Tous</option>';

        if (filterType) {
            fetch(`/stock/get_filter_values/?filter_type=${filterType}`)
                .then(response => response.json())
                .then(data => {
                    data.forEach(item => {
                        var option = document.createElement('option');
                        option.value = item.id;
                        option.textContent = filterType === 'category' ? item.nom_cat : (filterType === 'site' ? item.nom : item.nom_util);
                        filterValueSelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Error:', error));
        }
    });

    document.getElementById('filter_type').dispatchEvent(new Event('change'));
</script>
{% endblock javascript %}
